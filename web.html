<html>
<title>技能树</title>
<style>
.alsp{ font-family:"微软雅黑";}
.button {
  display: inline-block;
  border-radius: 4px;
  background-color: #236B8E;
  border: none;
  color: #FFFFFF;
  text-align: center;
  font-size: 12px;
  padding: 10px;
  width: 60px;
  transition: all 0.5s;
  cursor: pointer;
  margin: 5px;
  vertical-align:middle;
}

.button span {
  cursor: pointer;
  display: inline-block;
  position: relative;
  transition: 0.5s;
}

.button span:after {
  content: '»';
  position: absolute;
  opacity: 0;
  top: 0;
  right: -20px;
  transition: 0.5s;
}

.button:hover span {
  padding-right: 10px;
}

.button:hover span:after {
  opacity: 1;
  right: 0;
}


</style>
<head><script type="text/javascript" src="http://d3js.org/d3.v5.min.js"></script></head>
<body>
	<div class="alsp">
  	<h3 style="text-align:center;color:#D2E9FF;font-size:25px>">请输入 人员信息_技能树_所在公司历程：</h3>
	</div>
	<p style="text-align:center">
	<textarea cols="60" rows="10" id="text"></textarea>
 	</p>
	<p style="text-align:center">
	<button class="button" onclick="getTextareaValue()"><span>提交</span></button>
	</p>	 
	<script>
	d3.select("body").style("background-image","url(http://m.qpic.cn/psc?/V10sZkox0PHKFv/45NBuzDIW489QBoVep5mcXOf*hQuLVjekb.EU8i6vVmNweypCzfVB5*n5sKoygwcvjMhoF69rhAZ6Syg8UoIbq.41kLpF6FojGleAHZ*s4s!/b&bo=3AWEA9wFhAMBKQ4!&rf=viewer_4)")
	function getTextareaValue()
	{
		var content = document.all.text.value;
		var edge = new Map;
		var keyword = ["导师：","级硕士生：","级本科生：","级博士生："];
		var level = new Map;
		var farther = new Map; 
		var seen = [];
		idx_list = [];


		// input data process
		arr_str = content.split("\n");
		//arr_str = ["导师：张三", "2016级博士生：天一、王二、吴五", "2015级硕士生：李四、王五、许六", "2016级硕士生：刘一、李二、李三", "2017级本科生：刘六、琪七、司//四","", "刘六：JAVA、数学建模", "", "李二：字节跳动、京东云"]
		for (var idx = 0 ; idx < arr_str.length ; idx ++)
		{
			if (arr_str[idx] == "")
			{
				idx_list.push(idx);
			}
		}

		// get teacher and student relation
		for (var idx1 = 0 ; idx1 < idx_list[0] ; ) // layer 1
		{
			var idx2 = idx_list[0];
			//console.log(arr_str);
			//console.log(idx2);
			// get teacher
			var term1 = arr_str[idx1].split("：");
			var name = term1[1];
			edge[name] = [];
			seen.push(name);
			// layer 2
			for (idx3 = idx1 + 1 ; idx3 < idx2 ; idx3 ++)
			{
				for (var val of keyword) // (for of) is travel by values , (for in) is travel by keys
				{
					if (arr_str[idx3].indexOf(val) != -1)
					{
						//console.log(val);
						var term2 = arr_str[idx3].split("：");
						var temp = term2[0] + name;
						//console.log(temp);
						edge[name].push(temp);
						edge[temp] = [];
						level[temp] = val;
						farther[temp] = 1;
						seen.push(temp);
						break;	
					}
				}
				// layer 3
				var term3 = term2[1].split("、");
				for (var val of term3)
				{
					//console.log(val);
					edge[temp].push(val);
					//edge[val] = [];
					level[val] = term2[0];
					farther[val] = 1;
					seen.push(val);
				}
			}
			idx1 = idx2 + 1;
		}
		//console.log(idx1,idx2,idx3) 6 5 5
		//console.log(edge)


		// get skills
		var flag = 0;
		for (idx3 = idx1 ; idx3 < idx_list[1] ; idx3 ++)
		{
		    for (var val of seen)
			{
			    if (edge.hasOwnProperty(val))
				{
				    var check = edge[val];
				    //console.log(val);
				    for (var c of check)
					{
					    // val is farther
						var term2 = arr_str[idx3].split("：");
						var temp = term2[0] + val; // current and farther
						//console.log(c);
						//console.log(temp);

						if (term2[0] == c)
						{
							//console.log(temp,val);
							edge[term2[0]] = [];
							level[temp] = val;
							farther[temp] = 1;
							seen.push(temp);
							flag = 1;
							break;
						}
					}
                }
				if (flag == 1) break;
			}
			var term3 = term2[1].split("、");
		    for (var val of term3)
				{
					//console.log(val);
					edge[term2[0]].push(val);
					level[val] = term2[0];
					farther[val] = 1;
					seen.push(val);
				}
		}
		//onsole.log(edge);
		//console.log(idx1,idx2,idx3);


		// get work
		var flag = 0;
		for (idx3 = idx_list[1] + 1 ; idx3 < arr_str.length ; idx3 ++)
		{
		    for (var val of seen)
			{
			    if (edge.hasOwnProperty(val))
				{
				    var check = edge[val];
				    for (var c of check)
					{
					    var term2 = arr_str[idx3].split("：");

					    var temp = term2[0] + val;

					    if (term2[0] == c)
						{
						    //console.log(val,c);
						    flag = 1;
						    edge[term2[0]] = [];
							level[temp] = val;
							farther[temp] = 1;
							seen.push(temp);
							break;
						}

					}
					if (flag == 1) break;
				}
			}
			var term3 = term2[1].split("、");
		    for (var val of term3)
			{
				//console.log(val);
				edge[term2[0]].push(val);
				level[val] = temp;
				farther[val] = 1;
				seen.push(val);
			}
		}
		console.log(edge);


		// find root node
		for (var val of seen)
		{
			if (farther[val] == null)
			{
			    var root_name = val;
			    //console.log(root);
			}
		}


		function dfs(n,f) // construct object
		{

			var obj;
			obj = {};
			obj.name = n;
			obj.children = [];
			var item_list = edge[n];


			if (item_list == null)
			{
			    console.log(n);
			    return obj;
			}

			for (var i = 0 ; i < item_list.length ; i ++)
			{
				obj.children.push(dfs(item_list[i],n));
			}

			if (n.indexOf(f) != -1) // not farther
			{
			    var c = n.substring(0,n.indexOf(f));
			    obj.name = c;
			}

			return obj;
        }
        var root = dfs(root_name,-1);
		console.log(root);
		//console.log(edge["刘六"])
	}


	</script>
</body>
</html>